<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: Week 3 assignment</title>
		<script type="text/javascript" src="d3.js"></script>
		<style type="text/css">
			/* No style rules here yet */

		</style>
	</head>
  <!-- TODO: - fix overflowing yscale - returns 500, when max height is 400  -->
	<body>

		<p>This is a reproduction of </p><a href="http://iquantny.tumblr.com/post/129373499164/this-is-quantifiably-the-best-month-to-go-to-the"> http://iquantny.tumblr.com/post/129373499164/this-is-quantifiably-the-best-month-to-go-to-the</a>

    <h1>This is Quantifiably the Best Month to go to the Farmers Market</h1>
    <p>As part of a homework assignment, I ask my students at Pratt to go out and chart something of interest to them, and Katherine Savarese came back with a simple chart about farmers markets that I loved- it inspired this post.
You probably know that farmers markets are a staple across all five boroughs of New York City, but September happens to be a very special month. Why is that?  Well, it turns out September is the month with the most unique types of fresh produce- forty three to be exact.
To show the current offerings, we charted how many types of fruits and vegetables are available by month, and showed if they were fresh or from storage. </p>

<p class = "fresh_fruit">Fresh Fruit</p>
<p class = "fresh_vegetable">Fresh Vegetable</p>
<p class = "storage_fruit">Storage Fruit</p>
<p class = "storage_vegetable">Storage Vegetable</p>

    <script type="text/javascript">

    d3.csv("week3.csv", function(error, data) {
      if (error) { //If error is not null, something went wrong.
        console.log(error); //Log the error.
    } else { //If no error, the file loaded correctly. Yay!
        dataset = data;
        //dummy data
        //dataset = [1,4,7,8,15]
        prepareDataset();
      }
    });

    //global array selection
    var selected = [];

    var first = true;

    var w = 600;
    var h = 400;
    var barPadding = 1;
    var padding = 40;

    var prepareDataset = function() {

      //takes an index and creates global subselecton array
      var formSubselection = function(counter) {
        selected = [];
        for (i = 0; i < dataset.length; i++){
          if (dataset[i]["Index"] == counter)
            selected.push(dataset[i]);//push the whole record
        }
        //alert("index = ", counter);
        console.log(selected);
        if (first) { //if first viz, then draw, if not, only update
          generateNewVis();
          first = false;
        }
      }

      d3.select(".fresh_fruit")
        .on("click", function() {
          formSubselection(0);
          updateBars();
        });

      d3.select(".fresh_vegetable")
        .on("click", function() {
          formSubselection(1);
          updateBars();
      });
      d3.select(".storage_fruit")
        .on("click", function() {
          formSubselection(2);
          updateBars();
      });
      d3.select(".storage_vegetable")
        .on("click", function() {
          formSubselection(3);
          updateBars();
      });
    }

    var updateBars = function() {

      var xScale = d3.scaleOrdinal()
                     .domain(["apple", "orange", "banana", "grapefruit"])
                     .range([0, w]);

      var yScale = d3.scaleLinear()
                     .domain([0, d3.max(selected, function(d) { return d["Count"] })])
                     .range([0, h]);

    var xAxis = d3.axisBottom(xScale);

     //Define Y axis
     var yAxis = d3.axisLeft()
                   .scale(yScale)
                   .ticks(5);

      var svg = d3.selectAll("rect")
                  .data(selected)
                  .attr("x", function(d, i) {
                      return i * (w / selected.length);
                  })
                  .attr("y", function(d) {
                      return h - (yScale(d["Count"])); //height minus data - to inverse bar chart
                  })
                  .attr("width", w / selected.length - barPadding)
                  .attr("height", function(d) {
                      console.log(yScale(d["Count"]));
                      return yScale(d["Count"]);
                  })
                  .attr("fill", function(d) {
                      return "rgb(0, 0, " + Math.round(d * 10) + ")";
              });
      console.log(svg);

      svg.append("g")
         .attr("class", "axis")
         .attr("transform", "translate(" + padding + ",0)")
         .call(yAxis);

         svg.append("g")
            .attr("class", "axis") //Assign "axis" class
            .call(xAxis);
    }

    var generateNewVis = function() {

        //Create SVG element
        var svg = d3.select("body")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

                    var xScale = d3.scaleOrdinal()
                                   .domain(["apple", "orange", "banana", "grapefruit"])
                                   .range([0 + padding, w]);

                    var yScale = d3.scaleLinear()
                                   .domain([0, d3.max(selected, function(d) { return d["Count"] })])
                                   .range([0, h]);

                  var xAxis = d3.axisBottom(xScale);

                   //Define Y axis
                   var yAxis = d3.axisLeft()
                                 .scale(yScale)
                                 .ticks(5);

          svg.selectAll("rect")
              .data(selected)
              .enter()
              .append("rect")
              .attr("x", function(d, i) {
                  return i * (w / selected.length);
              })
              .attr("y", function(d) {
                  //return h - (d["Count"] * 4); //height minus data - to inverse bar chart
                  return h - (yScale(d["Count"]));
              })
              .attr("width", w / selected.length - barPadding)
              .attr("height", function(d) {
                  console.log("first " + yScale(d["Count"]));
                  return yScale(d["Count"]);
              })
              .attr("fill", function(d) {
                  return "rgb(0, 0, " + Math.round(d * 10) + ")";
          });

          svg.append("g")
             .attr("class", "axis")
             .attr("transform", "translate(" + padding + ",0)")
             .call(yAxis);

             svg.append("g")
                .attr("class", "axis") //Assign "axis" class
                .call(xAxis);

    }

		</script>
	</body>
</html>
